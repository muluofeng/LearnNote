## redis 主从复制

主机数据更新后根据配置和策略，自动同步到备机的master/slaver机制，Master以写为主，Slave以读为主



#### 一主二从

1. 配从(库)不配主(库) ,也就是只需要在从库上面配置

2. 从库配置： 

   ​        **slaveof 主库IP 主库端口**

3. 每次与master断开之后，都需要重新连接，除非你配置进redis.conf文件

4. 查看复制信息：  **info replication**

5.  当redis作为slave的时候 ，不能进行写操作，只有主机才能写

6. 主机如果挂了，从机就等待主机重新连上，然后才能把主机的信息同步给从机

7. **SLAVEOF no one**  使当前数据库停止与其他数据库的同步，转成主数据库

   

   

   

   

   ## 复制原理

   1. slave启动成功连接到master后会发送一个sync命令
   2. Master接到命令启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，
      在后台进程执行完毕之后，master将传送整个数据文件到slave,以完成一次完全同步
   3. 全量复制：而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中。
   4. 增量复制：Master继续将新的所有收集到的修改命令依次传给slave,完成同步
   5. 但是只要是重新连接master,一次完全同步（全量复制)将被自动执行

   

   

   

   ## 哨兵模式

   反客为主的自动版，能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库

   

   #### 使用步骤

   1. 调整结构，6379的redis 带着6380、6381

   2. 自定义的/myredis目录下新建sentinel.conf文件，名字绝不能错

   3. 配置哨兵,填写内容
      	 **sentinel monitor 被监控数据库名字(自己起名字) 127.0.0.1 6379 1**
      	上面最后一个数字1，表示主机挂掉后salve投票看让谁接替成为主机，得票数多少后成为主机

   4. 启动哨兵 

      ​	redis-sentinel  /myredis/sentinel.conf 

   

   