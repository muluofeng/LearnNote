
### TCP/IP 五层模型

![img](http://qiniu.muluofeng.com/uPic/2021/12/Center.jpeg)



#### 1. 物理层

物理层主要基于电器特性发送高低电平信号(0和1)

#### 2. 数据链路层

有单纯的0和1没有任何意义， 在实际的应用中会将电平信号进行分组，多少位为一组，这样数据才有意义，数据链路层定义电平信号的分组方式

数据链路层采用 以太网协议（Ethernet以太网）进行数据传输 



![2021126/1638769421390.png](http://qiniu.muluofeng.com/2021126/1638769421390.png)


```
以太网的数据结构： 由一组电平信号构成的一个数据包 ，叫做帧 ，每一个数据帧有报头Head和数据DATA组成

​		Head:  固定18字节 ，发送者源地址6字节，接受者目标地址 6 字节,数据类型 6 字节

​		Data:  最短46字节，最长 1500 字节

  超过就最大（1500+18字节）限制就分片发送
  
  以太网协议：基于MAC 地址的广播方式实现数据传输，只能在局域网内进行广播
  
  

MAC 地址：以太网规定截图的Internet 设备必须有网卡，发送端的和接收端的地址就是网卡的地址，就是 MAC 地址（每台电脑出厂时都有一个世界上唯一的MAC地址，48位的二进制，12位16进制表示，前6位是厂商编号，后6位是流水线号）


Broadcast 广播：有了MAC地址同一网络的主机就能通信了（一台主机通过ARP协议获取另一个主机的MAC地址），通过广播的方式进行通信，那么子网中的每台机器都会收到一个包，解包出来看看对方要发送的MAC地址是不是自己，如果是就处理，不是就丢弃

  
```





#### 3. 网络层

有了 以太网、MAC地址、广播的形式，世界上的计算机就可以彼此就行通信了，问题是世界上互联网由一个个小的局域网组成，如果所有通信的都采用以太网的形式进行广播，那么所有的机器都会收到数据包，效率低下，而且会是一种灾难，所以以太网数据包只能在局域网内发送，跨局域网只能通过路由进行转发，那么必须找出一种方法确认计算机属于同一个局域网，那些不是，网络层的作用就是引入一套新的地址来区分不同的子网


![2021126/1638769539620.png](http://qiniu.muluofeng.com/2021126/1638769539620.png)


```
IP : 规定网络地址的协议叫做IP ,定义的地址叫做IP 地址，广泛采用V4版本即IPv4,32位二进制组成，通常写成4段10进制，取值范围位 0.0.0.0 ~ 255.255.255.255

子网掩码：由于IP地址的数量最多有 2^32  个，解决IP地址分配而产生的子网掩码，子网掩码表示网络特征的参数，也是一个32位的二进制数，我们根据子网掩码就能直到任意两个IP               是否处于同一个子网网络

IP数据包： 也分为 Head和Data部分，无需为IP数据包定义单独的栏位，直接放入以太网的包的Data部分即可，由于以太网data最大1500，所以IP数据包超过1500字节就要放开发送

ARP协议： 用于实现从IP地址到MAC地址的映射，即询问目标IP对应的MAC地址，以广播的形式发送数据包，获取目标主机的MAC地址
```



#### 4. 传输层

网络层IP区分子网， 以太网的MAC地址找到主机，大家使用的都是应用程序，如何确定是哪个应用程序呢，答案是 端口，传输层就是用来建立 端口到端口的通信机制

```
端口的取值范围为0-65535， 为什么是这个数字呢，因为TCP 头部留给存储端口的空间只有2字节 = 2^8*2^8=65535

TCP: 传输控制协议

UDP: 用户数据包协议
```



![img](http://qiniu.muluofeng.com/uPic/2021/12/77fiE3.jpeg)



TCP 包是没有 IP 地址的，但有源端口和目的端口，用来标识通信的进程。

- `Sequence Number` 是记录包的序号，TCP 会按照报文字节进行编号，它是用来解决包在网络中乱序的问题。

- `Acknowledgement Number` 确认序列号，是用于向发送方确认已经收到了哪些包，用来解决不丢包的问题。

- `Windows` 也叫 `Advertised-Windows`，也就是著名的滑动窗口，主要是用来解决流控的。控制发送端的发送速率）

- TCP flags 标志位，一共6个  SYN、ACK,下面两个在 TPC 握手中会用到

  ```
  SYN :同步序号标志
  ACK :确认序号标志
  ```

  

参考： https://www.eet-china.com/mp/a44399.html

TCP握手的目的： 使通信的双方确知对方的存在，可以允许通信的双方协商一些参数

![img](http://qiniu.muluofeng.com/uPic/2021/12/uqEjMv.png)

注意上图中的  ack 和ACK  , ack表示确认序号，ACK 表示TCP flags 标志位的ACK 

```
ack和seq都是两个整型变数

SYN和ACK是用来标识这个包的型别的
```



- 客户端发送 SYN 包（syn=1）到服务器
- 服务器收到包后，必须确认客户端的syn包（ack=x+1）发送 SYN包 同时 SYN =1、ACK=1  即  SYN+ACK包
- 客户端收到 SYN+ACK 包，客户端发送 ACK包（ack=y+1） 完成3次握手



为什么 TCP 采用三次握手，二次握手可以吗？

**（一）确认双方的收发能力**



TCP 建立连接之前，需要确认客户端与服务器双方的收包和发包的能力。

*1.* 第一次握手：客户端发送网络包，服务端收到了。这样服务端就能得出结论：客户端的发送能力、服务端的接收能力是正常的。

*2.* 第二次握手：服务端发包，客户端收到了。这样客户端就能得出结论：服务端的接收、发送能力，客户端的接收、发送能力是正常的。不过此时服务器并不能确认客户端的接收能力是否正常。

*3.* 第三次握手：客户端发包，服务端收到了。这样服务端就能得出结论：客户端的接收、发送能力正常，服务器自己的发送、接收能力也正常。

所以，只有三次握手才能确认双方的接收与发送能力是否正常。



**（二）序列号可靠同步**

如果是两次握手，服务端无法确定客户端是否已经接收到了自己发送的初始序列号，如果第二次握手报文丢失，那么客户端就无法知道服务端的初始序列号，那 TCP 的可靠性就无从谈起。



**（三）阻止重复历史连接的初始化**

客户端由于某种原因发送了两个不同序号的 `SYN` 包，我们知道网络环境是复杂的，旧的数据包有可能先到达服务器。如果是两次握手，服务器收到旧的 `SYN` 就会立刻建立连接，那么会造成网络异常。

如果是三次握手，服务器需要回复 `SYN+ACK` 包，客户端会对比应答的序号，如果发现是旧的报文，就会给服务器发 `RST` 报文，直到正常的 `SYN` 到达服务器后才正常建立连接。

所以三次握手才有足够的上下文信息来判断当前连接是否是历史连接。



**（四）安全问题**

我们知道 TCP 新建连接时，内核会为连接分配一系列的内存资源，如果采用两次握手，就建立连接，那会放大 DDOS 攻击的。

TCP 作为一种可靠传输控制协议，其核心思想：既要保证数据可靠传输，又要提高传输的效率，而三次握手恰好可以满足以上两方面的需求！



#### 5. 应用层


